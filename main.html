<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Power - App</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <!-- Chart.js CDN (خيار مدمج ESP: ضع نسخة مصغرة محلياً لو لزم الأمر) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-title"><i class="fas fa-plug"></i> Smart Power</div>
      <div class="sidebar-links">
        <a
          class="sidebar-link active"
          href="javascript:void(0);"
          onclick="showPage('dashboard')"
        >
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a
          class="sidebar-link"
          href="javascript:void(0);"
          onclick="showPage('history')"
        >
          <i class="fas fa-chart-line"></i> History / Analytics
        </a>
        <a
          class="sidebar-link"
          href="javascript:void(0);"
          onclick="showPage('settings')"
        >
          <i class="fas fa-cog"></i> Settings
        </a>
        <a
          class="sidebar-link"
          href="javascript:void(0);"
          onclick="showPage('network')"
        >
          <i class="fas fa-network-wired"></i> Network Info
        </a>
        <a
          class="sidebar-link"
          href="javascript:void(0);"
          onclick="showPage('system')"
        >
          <i class="fas fa-tools"></i> System / Admin
        </a>
        <a
          class="sidebar-link"
          href="javascript:void(0);"
          onclick="showPage('login')"
        >
          <i class="fas fa-sign-in-alt"></i> Login
        </a>
      </div>
      <div class="sidebar-footer">&copy; 2025 Smart Power</div>
    </nav>
    <!-- الزر الموحد (فتح/إغلاق) -->
    <button
      class="sidebar-toggle"
      id="sidebarToggle"
      aria-label="Open/Close Sidebar"
    >
      <i class="fas fa-bars"></i>
      <i class="fas fa-times"></i>
    </button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <!-- زر تغيير الوضع -->
    <button class="theme-toggle-demo" id="themeToggleBtn" title="Toggle Theme">
      <i class="fas fa-moon"></i>
    </button>

    <!-- !-------------------------- -->
    <!-- MAIN CONTENT -->
    <div class="main-content">
      <!-- Dashboard Page -->
      <div class="page active" id="dashboard">
        <div class="title"><i class="fas fa-plug"></i> Smart Power Monitor</div>
        <div class="alert" id="alertBox">⚠️ Low Power Factor Detected!</div>
        <audio
          id="alertSound"
          src="https://www.soundjay.com/buttons/sounds/beep-07.mp3"
          preload="auto"
        ></audio>
        <div class="grid" id="cards"></div>
      </div>
      <!--! History / Analytics Page -->
      <div class="page" id="history">
        <div class="title">
          <i class="fas fa-chart-line"></i> History / Analytics
        </div>
        <div class="section filter-row">
          <label for="periodSelect" class="form-label"
            ><i class="fa fa-filter"></i> Period</label
          >
          <select
            id="periodSelect"
            class="input"
            style="width: auto; display: inline-block"
          >
            <option value="today">اليوم</option>
            <option value="week">الأسبوع</option>
            <option value="month">الشهر</option>
            <option value="custom">مخصص</option>
          </select>
          <input
            type="date"
            id="fromDate"
            class="input"
            style="display: none; width: auto; display: inline-block"
          />
          <span id="toLabel" style="display: none">إلى</span>
          <input
            type="date"
            id="toDate"
            class="input"
            style="display: none; width: auto; display: inline-block"
          />
        </div>

        <div class="section">
          <div class="section-title">
            استهلاك الطاقة التراكمي (kWh)
            <span
              style="
                font-weight: normal;
                color: var(--card-label);
                font-size: 0.92em;
              "
              >حسب الفترة</span
            >
          </div>
          <canvas id="cumulativeChart" height="110"></canvas>
        </div>

        <div class="section">
          <div class="section-title">مخططات الأداء التاريخية</div>
          <div class="cards-grid charts-grid">
            <div class="analytics-chart card">
              <div class="label">الطاقة Power</div>
              <canvas id="powerChart" height="70"></canvas>
            </div>
            <div class="analytics-chart card">
              <div class="label">الجهد Voltage</div>
              <canvas id="voltageChart" height="70"></canvas>
            </div>
            <div class="analytics-chart card">
              <div class="label">التيار Current</div>
              <canvas id="currentChart" height="70"></canvas>
            </div>
            <div class="analytics-chart card">
              <div class="label">معامل القدرة PF</div>
              <canvas id="pfChart" height="70"></canvas>
            </div>
          </div>
        </div>
        <div class="section">
          <div class="section-title">أفضل وأسوأ الأيام</div>
          <div class="best-worst-list" id="bestWorstList">
            <!-- سيتم تعبئتها ديناميكياً -->
          </div>
        </div>
        <!-- نافذة تفاصيل اليوم -->
        <div class="day-detail-pop" id="dayDetailPop" style="display: none">
          <div class="day-detail-box section">
            <span
              class="close-detail btn"
              id="closeDetailBtn"
              style="float: left; font-size: 1.3em; padding: 4px 12px 5px 12px"
              >&times;</span
            >
            <div
              class="day-detail-title title"
              id="dayDetailTitle"
              style="font-size: 1.1em; margin-bottom: 10px"
            ></div>
            <div class="day-detail-list" id="dayDetailList"></div>
          </div>
        </div>
      </div>
      <!-- !Settings Page -->
      <div class="page" id="settings">
        <div class="title"><i class="fas fa-cog"></i> الإعدادات</div>
        <form class="settings-card" id="settingsForm" autocomplete="off">
          <!-- Wi-Fi -->
          <div class="settings-group">
            <span class="settings-label"
              ><i class="fas fa-wifi"></i> إعدادات Wi-Fi</span
            >
            <div class="input-row">
              <label for="ssid" style="min-width: 65px">SSID</label>
              <input
                type="text"
                id="ssid"
                name="ssid"
                required
                maxlength="32"
                autocomplete="off"
              />
            </div>
            <div class="input-row">
              <label for="wifiPass" style="min-width: 65px">Password</label>
              <input
                type="password"
                id="wifiPass"
                name="wifiPass"
                maxlength="63"
                autocomplete="new-password"
              />
            </div>
          </div>
          <!-- Threshold -->
          <div class="settings-group">
            <span class="settings-label"
              ><i class="fa fa-exclamation-triangle"></i> حد معامل القدرة
              الأدنى</span
            >
            <input
              type="number"
              step="0.01"
              min="0.7"
              max="1"
              id="pfThreshold"
              name="pfThreshold"
              value="0.85"
              required
            />
          </div>
          <!-- صوت التنبيه -->
          <div class="settings-group">
            <span class="settings-label"
              ><i class="fa fa-volume-up"></i> صوت التنبيه</span
            >
            <label style="font-weight: normal">
              <input type="checkbox" id="soundEnable" name="soundEnable" />
              تفعيل الصوت
            </label>
          </div>
          <!-- المنطقة الزمنية -->
          <div class="settings-group">
            <span class="settings-label"
              ><i class="fa fa-clock"></i> المنطقة الزمنية</span
            >
            <select id="timezone" name="timezone">
              <option value="UTC+0">UTC+0</option>
              <option value="UTC+1">UTC+1</option>
              <option value="UTC+2">UTC+2</option>
              <option value="UTC+3">UTC+3</option>
              <option value="UTC+4">UTC+4</option>
              <option value="UTC+5">UTC+5</option>
              <option value="UTC+6">UTC+6</option>
              <option value="UTC+7">UTC+7</option>
              <option value="UTC+8">UTC+8</option>
              <option value="UTC+9">UTC+9</option>
              <option value="UTC+10">UTC+10</option>
              <option value="UTC+11">UTC+11</option>
              <option value="UTC+12">UTC+12</option>
              <option value="UTC-1">UTC-1</option>
              <option value="UTC-2">UTC-2</option>
              <option value="UTC-3">UTC-3</option>
              <option value="UTC-4">UTC-4</option>
              <option value="UTC-5">UTC-5</option>
              <option value="UTC-6">UTC-6</option>
              <option value="UTC-7">UTC-7</option>
              <option value="UTC-8">UTC-8</option>
              <option value="UTC-9">UTC-9</option>
              <option value="UTC-10">UTC-10</option>
              <option value="UTC-11">UTC-11</option>
              <option value="UTC-12">UTC-12</option>
            </select>
          </div>
          <button class="save-btn" type="submit">
            <i class="fas fa-save"></i> حفظ الإعدادات
          </button>
          <div class="settings-alert" id="alertMsg"></div>
        </form>
      </div>
      <!--! Network Info Page -->
      <div class="page" id="network">
        <div class="title">
          <i class="fas fa-network-wired"></i> معلومات الشبكة
        </div>
        <div class="network-card" id="netCard">
          <div class="net-row">
            <label><i class="fa fa-globe"></i> عنوان IP:</label>
            <span class="net-val" id="ipVal">--</span>
          </div>
          <div class="net-row">
            <label><i class="fa fa-wifi"></i> الشبكة:</label>
            <span class="net-val" id="ssidVal">--</span>
          </div>
          <div class="net-row">
            <label><i class="fa fa-signal"></i> الإشارة:</label>
            <span class="net-val" id="rssiVal">--</span>
          </div>
          <div class="net-btn-row">
            <button class="net-btn" onclick="refreshNetworkInfo()">
              <i class="fa fa-sync"></i> تحديث
            </button>
            <button class="net-btn" onclick="reconnectWifi()">
              <i class="fa fa-redo"></i> إعادة الاتصال
            </button>
          </div>
          <div class="net-alert" id="netAlert"></div>
          <div class="ota-sec">
            <span class="ota-label"
              ><i class="fa fa-upload"></i> ترقية البرنامج (Firmware OTA)</span
            >
            <form id="otaForm" enctype="multipart/form-data" autocomplete="off">
              <input
                class="ota-input"
                type="file"
                id="otaFile"
                name="firmware"
                accept=".bin"
                required
              />
              <button class="ota-btn" type="submit">
                <i class="fa fa-flash"></i> رفع و ترقية
              </button>
            </form>
            <div class="net-alert" id="otaAlert"></div>
          </div>
        </div>
      </div>
      <!-- !System / Admin Page -->
      <div class="page" id="system">
        <div class="title"><i class="fas fa-tools"></i> الإدارة والصيانة</div>
        <div class="admin-card">
          <!-- أزرار النظام -->
          <div class="admin-section">
            <div class="admin-section-title">
              <i class="fa fa-power-off"></i> نظام الجهاز
            </div>
            <div class="admin-btn-row">
              <button
                class="admin-btn danger"
                onclick="confirmDialog('هل تريد إعادة تشغيل الجهاز؟','reboot')"
              >
                <i class="fa fa-sync"></i> إعادة تشغيل
              </button>
              <button
                class="admin-btn danger"
                onclick="confirmDialog('هل تريد فعلاً مسح البيانات المخزنة؟','clearMemory')"
              >
                <i class="fa fa-trash"></i> مسح البيانات
              </button>
              <button class="admin-btn" onclick="downloadCSV()">
                <i class="fa fa-download"></i> تحميل البيانات CSV
              </button>
            </div>
            <div class="admin-btn-row" style="margin-top: 0">
              <form
                id="otaForm"
                enctype="multipart/form-data"
                style="display: inline-block"
              >
                <input
                  style="display: inline-block; width: 63%"
                  type="file"
                  id="otaFile"
                  name="firmware"
                  accept=".bin"
                  required
                />
                <button class="admin-ota-btn" type="submit">
                  <i class="fa fa-upload"></i> رفع Firmware يدوي
                </button>
              </form>
            </div>
          </div>
          <!-- السجلات -->
          <div class="admin-section">
            <div class="admin-section-title">
              <i class="fa fa-history"></i> السجلات (Logs)
            </div>
            <div class="logs-list" id="logsList">
              <div class="log-item">-- لا يوجد بيانات --</div>
            </div>
          </div>
          <div class="admin-alert" id="adminAlert"></div>
        </div>
      </div>
      <!-- !Login Page -->
      <div class="page" id="login">
        <div class="login-container">
          <div class="login-header"><i class="fas fa-lock"></i> Login</div>
          <form class="login-form" id="loginForm" autocomplete="off">
            <div>
              <label for="username">Username</label>
              <input
                type="text"
                id="username"
                autocomplete="username"
                required
              />
            </div>
            <div>
              <label for="password">Password</label>
              <input
                type="password"
                id="password"
                autocomplete="current-password"
                required
              />
            </div>
            <button class="login-btn" type="submit">
              <i class="fas fa-sign-in-alt"></i> Login
            </button>
            <div class="error-msg" id="errorMsg">
              <i class="fas fa-exclamation-circle"></i>
              Invalid username or password!
            </div>
          </form>
          <div class="login-footer">&copy; 2025 Smart Power</div>
        </div>
      </div>
      <div class="footer">&copy; Smart Power Monitor Dashboard</div>
    </div>
    <!-- !-------------------------- -->
    <script>
      // سايدبار (فتح/إغلاق)
      const sidebar = document.getElementById("sidebar");
      const sidebarToggle = document.getElementById("sidebarToggle");
      const sidebarOverlay = document.getElementById("sidebarOverlay");
      sidebarToggle.onclick = () => {
        const open = !sidebar.classList.contains("open");
        sidebar.classList.toggle("open", open);
        document.body.classList.toggle("sidebar-open", open);
      };
      sidebarOverlay.onclick = () => {
        sidebar.classList.remove("open");
        document.body.classList.remove("sidebar-open");
      };
      // إغلاق عند الضغط على أي رابط
      document.querySelectorAll(".sidebar-link").forEach((link) =>
        link.addEventListener("click", () => {
          sidebar.classList.remove("open");
          document.body.classList.remove("sidebar-open");
        })
      );
      // إغلاق بالـ ESC
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          sidebar.classList.remove("open");
          document.body.classList.remove("sidebar-open");
        }
      });
      // زر تبديل الوضع الليلي/النهاري
      document.getElementById("themeToggleBtn").onclick = function () {
        document.body.classList.toggle("dark");
        // تبديل أيقونة القمر/الشمس
        const icon = this.querySelector("i");
        icon.classList.toggle("fa-moon");
        icon.classList.toggle("fa-sun");
      };

      // نظام الصفحات بدون jQuery
      function showPage(pageId) {
        // إخفاء جميع الصفحات
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        // إظهار الصفحة المطلوبة
        const page = document.getElementById(pageId);
        if (page) page.classList.add("active");
        // تفعيل الرابط في السايدبار
        document
          .querySelectorAll(".sidebar-link")
          .forEach((link) => link.classList.remove("active"));
        // حدد الرابط بناءً على الصفحة
        document.querySelectorAll(".sidebar-link").forEach((link) => {
          if (
            link.getAttribute("onclick") &&
            link.getAttribute("onclick").includes("'" + pageId + "'")
          ) {
            link.classList.add("active");
          }
        });
      }

      // صفحة تسجيل الدخول (التحقق البسيط وتخزين الجلسة)
      document
        .getElementById("loginForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value;
          const errorMsg = document.getElementById("errorMsg");
          // مثال فقط: اسم مستخدم admin وكلمة مرور 1234
          if (username === "admin" && password === "1234") {
            localStorage.setItem("smartpower_token", "demo-token-123456");
            showPage("dashboard");
          } else {
            errorMsg.style.display = "flex";
          }
        });
      document.getElementById("username").addEventListener("input", () => {
        document.getElementById("errorMsg").style.display = "none";
      });
      document.getElementById("password").addEventListener("input", () => {
        document.getElementById("errorMsg").style.display = "none";
      });
    </script>
    <!-- !+++++++++++++++++++++++++ -->
     <script>
        // Dashboard logic (cards + charts)
    const labels = [];
    const charts = {};
    const dataStore = {};
    let alertPlayed = false;

    const measurements = [
      { key: 'voltage', label: 'Voltage', unit: 'V', icon: 'bolt', color: '#f1c40f' },
      { key: 'current', label: 'Current', unit: 'A', icon: 'exchange-alt', color: '#3498db' },
      { key: 'power', label: 'Power', unit: 'W', icon: 'plug', color: '#e74c3c' },
      { key: 'energy', label: 'Energy', unit: 'kWh', icon: 'battery-full', color: '#2ecc71' },
      { key: 'apparent', label: 'Apparent Power', unit: 'VA', icon: 'bolt-lightning', color: '#8e44ad' },
      { key: 'reactive', label: 'Reactive Power', unit: 'VAR', icon: 'bolt', color: '#d35400' },
      { key: 'frequency', label: 'Frequency', unit: 'Hz', icon: 'wave-square', color: '#9b59b6' },
      { key: 'pf', label: 'Power Factor', unit: '', icon: 'percent', color: '#e67e22' }
    ];
    measurements.forEach(m => dataStore[m.key] = []);

    function createCard(m) {
      return `
        <div class="card">
          <div class="card-header">
            <i class="fas fa-${m.icon} icon" style="color:${m.color}"></i>
            <div>
              <div class="label">${m.label}</div>
              <div class="value" id="${m.key}_val">-- <span class="unit">${m.unit}</span></div>
            </div>
          </div>
          <canvas id="chart_${m.key}" height="100"></canvas>
        </div>`;
    }
    function createChart(ctx, color, dataArr) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            data: dataArr,
            borderColor: color,
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            pointRadius: 0
          }]
        },
        options: {
          animation: false,
          responsive: true,
          scales: { x: { display: false }, y: { beginAtZero: true } },
          plugins: { legend: { display: false } }
        }
      });
    }

    function simulateData() {
      const now = new Date();
      labels.push(now.toLocaleTimeString());

      const v = +(220 + Math.random() * 10).toFixed(1);
      const c = +(Math.random() * 5).toFixed(2);
      const p = +(v * c * 0.8).toFixed(1);
      const s = +(v * c).toFixed(1);
      const q = +(Math.sqrt(s * s - p * p)).toFixed(1);
      const e = +(+(dataStore.energy.at(-1) || 0) + (p / 3600000) * 2).toFixed(3);
      const f = +(49.5 + Math.random()).toFixed(2);
      const pf = +(p / s).toFixed(2);

      const values = { voltage: v, current: c, power: p, energy: e, frequency: f, pf: pf, apparent: s, reactive: q };

      measurements.forEach(m => {
        dataStore[m.key].push(values[m.key]);
        if (dataStore[m.key].length > 30) dataStore[m.key].shift();
        document.getElementById(`${m.key}_val`).innerHTML = values[m.key] + `<span class="unit">${m.unit}</span>`;
        if (charts[m.key]) charts[m.key].update();
      });

      if (labels.length > 30) labels.shift();

      const alertBox = document.getElementById('alertBox');
      const alertSound = document.getElementById('alertSound');
      if (pf < 0.8) {
        alertBox.style.display = 'block';
        if (!alertPlayed) {
          alertSound.play();
          alertPlayed = true;
        }
      } else {
        alertBox.style.display = 'none';
        alertPlayed = false;
      }
    }

    // إنشاء الكروت والرسوم البيانية
    document.getElementById("cards").innerHTML = measurements.map(createCard).join('');
    measurements.forEach(m => {
      const ctx = document.getElementById(`chart_${m.key}`).getContext('2d');
      charts[m.key] = createChart(ctx, m.color, dataStore[m.key]);
    });

    // تحديث البيانات كل 2 ثانية (محاكاة)
    simulateData();
    setInterval(simulateData, 2000);  
     </script>
    <!-- !+++++++++++++++++++++++++ -->
  </body>
</html>
