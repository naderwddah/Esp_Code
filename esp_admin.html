<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>الإدارة والصيانة - Smart Power</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --accent: #3498db;
      --sidebar-width: 220px;
      --sidebar-bg: #f4f4f4;
      --sidebar-text: #222;
      --sidebar-hover: #e3e8f0;
      --main-bg: #f0f0f0;
      --main-text: #2c3e50;
      --card-bg: #fff;
      --card-text: #2c3e50;
      --card-label: #7f8c8d;
    }
    body.dark {
      --sidebar-bg: #1a202a;
      --sidebar-text: #e6e6e6;
      --sidebar-hover: #232a36;
      --main-bg: #121212;
      --main-text: #f1f1f1;
      --card-bg: #1e1e1e;
      --card-text: #f1f1f1;
      --card-label: #b0b0b0;
    }
    body {
      background: var(--main-bg);
      color: var(--main-text);
      font-family: Arial,sans-serif;
      margin: 0;
      min-height: 100vh;
      transition: background .22s, color .22s;
      direction: rtl;
    }
    .sidebar {
      position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100vh;
      background: var(--sidebar-bg); color: var(--sidebar-text); z-index: 2000;
      box-shadow: 0 2px 18px rgba(0,0,0,0.08);
      display: flex; flex-direction: column; padding-top: 46px;
      transform: translateX(-100%);
      transition: transform .23s, background .22s, color .22s;
      will-change: transform;
    }
    .sidebar.open { transform: none;}
    .sidebar .sidebar-title { text-align: center; font-weight: bold; font-size: 1.15em; margin-bottom: 27px; color: var(--accent);}
    .sidebar-links { flex: 1; display: flex; flex-direction: column; gap: 12px; padding: 0 20px;}
    .sidebar-link { display: flex; align-items: center; gap: 13px; padding: 11px 10px; border-radius: 8px; color: inherit; text-decoration: none; font-size: 1em; transition: background .18s, color .19s; cursor: pointer; border: none; background: none; outline: none; font-family: inherit;}
    .sidebar-link:hover, .sidebar-link.active { background: var(--sidebar-hover); color: var(--accent);}
    .sidebar-link i { width: 22px; text-align: center; font-size: 1.17em;}
    .sidebar-footer {text-align: center; padding: 15px 5px 12px 5px; font-size: 0.9em; color: #aaa; border-top: 1px solid #ddd;}
    body.dark .sidebar-footer { border-top: 1px solid #232a36; color: #888;}
    .sidebar-toggle {position: fixed; top: 16px; left: 16px; z-index: 2200; border: none; border-radius: 8px; font-size: 24px; cursor: pointer; padding: 8px 13px; background: #fff; color: var(--accent); box-shadow: 0 2px 6px rgba(0,0,0,0.07);}
    .sidebar-toggle .fa-bars { display: inline;}
    .sidebar.open ~ .sidebar-toggle .fa-bars { display: none;}
    .sidebar-toggle .fa-times { display: none;}
    .sidebar.open ~ .sidebar-toggle .fa-times { display: inline;}
    .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.13); z-index: 1999;}
    .sidebar.open ~ .sidebar-overlay { display: block;}
    body.sidebar-open { overflow: hidden;}
    .theme-toggle-demo { position: fixed; top: 17px; right: 16px; z-index: 2300; font-size: 21px; color: var(--accent); background: #fff; border-radius: 50%; padding: 8px; cursor: pointer; border: none; outline: none; box-shadow: 0 1px 5px rgba(0,0,0,0.07);}
    body.dark .theme-toggle-demo { color: #f1c40f; background: #232a36;}
    .main-content { margin-left: 0; padding: 50px 18px 0 18px; transition: margin .22s; min-height: 100vh;}
    @media (min-width: 700px) { .sidebar.open ~ .main-content { margin-left: var(--sidebar-width); } }
    .admin-title {
      text-align: center;
      color: var(--main-text);
      font-size: 1.5em;
      margin: 0 0 16px 0;
      font-weight: bold;
      letter-spacing: 1px;
    }
    .admin-card {
      background: var(--card-bg);
      border-radius: 13px;
      max-width: 480px;
      margin: 24px auto 0 auto;
      padding: 25px 22px 20px 22px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .admin-section {
      margin-bottom: 27px;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
    }
    .admin-section:last-child { border-bottom: none; }
    .admin-btn-row {
      display: flex; flex-wrap: wrap; gap: 11px; justify-content: center; margin-bottom: 8px; margin-top: 10px;
    }
    .admin-btn, .admin-ota-btn {
      padding: 9px 22px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 7px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.04em;
      transition: background .17s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .admin-btn:active, .admin-ota-btn:active { background: #2172b8;}
    .admin-btn.danger, .admin-ota-btn.danger { background: #e74c3c;}
    .admin-btn.danger:active, .admin-ota-btn.danger:active { background: #961a0d;}
    .admin-section-title {
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 7px;
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 1.08em;
    }
    .logs-list {
      background: var(--sidebar-hover);
      border-radius: 9px;
      padding: 11px 10px;
      margin-top: 8px;
      font-size: .99em;
      max-height: 195px;
      overflow-y: auto;
      direction: ltr;
      color: var(--main-text);
    }
    .log-item {
      border-bottom: 1px solid #ddd;
      padding: 5px 0;
      font-family: "Consolas", monospace;
      direction: ltr;
      text-align: left;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .log-item:last-child { border-bottom: none;}
    .admin-alert {
      text-align: center;
      margin: 11px 0 0 0;
      font-size: 1.06em;
      padding: 7px;
      border-radius: 7px;
      display: none;
    }
    .admin-alert.success { background: #d8f8e6; color: #146c43;}
    .admin-alert.fail { background: #ffe6e6; color: #c0392b;}
    .footer { margin: 36px auto 0 auto; text-align: center; font-size: 14px; color: #888;}
    /* Dialog overlay */
    .dialog-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.22); z-index: 5000; align-items: center; justify-content: center;
    }
    .dialog-box {
      background: var(--card-bg); color: var(--card-text);
      border-radius: 12px; min-width: 240px; max-width: 360px;
      padding: 18px 14px 12px 14px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.11);
      position: relative; text-align: center;
      direction: rtl;
    }
    .dialog-title { font-weight: bold; margin-bottom: 9px;}
    .dialog-btn-row { margin-top: 15px; display: flex; gap: 11px; justify-content: center;}
    .dialog-btn {
      padding: 7px 19px; border-radius: 7px; border: none; font-weight: bold;
      font-size: 1em; cursor: pointer;
      background: #d6e2ef; color: #2c3e50;
      transition: background .17s;
    }
    .dialog-btn.danger { background: #e74c3c; color: #fff;}
    .dialog-btn:active { background: #b1c3d7;}
    .dialog-btn.danger:active { background: #961a0d;}
    /* قفل الإدارة */
    .admin-lock-overlay {
      display: flex; align-items: center; justify-content: center;
      position: fixed; left: 0; right: 0; top: 0; bottom: 0;
      background: rgba(0,0,0,0.14);
      z-index: 10000;
      transition: background .22s;
    }
    .admin-lock-box {
      background: var(--card-bg); color: var(--card-text);
      border-radius: 12px; min-width: 250px; max-width: 350px;
      padding: 18px 16px 12px 16px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.14);
      text-align: center;
    }
    .admin-lock-title { font-weight: bold; margin-bottom: 12px; font-size: 1.1em;}
    .admin-lock-input {
      width: 80%;
      font-size: 1.09em;
      border-radius: 7px;
      border: 1px solid #ccc;
      padding: 6px 9px;
      background: var(--card-bg);
      color: var(--main-text);
      margin-bottom: 8px;
    }
    .admin-lock-btn {
      padding: 8px 22px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 7px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.04em;
      margin-top: 6px;
    }
    .admin-lock-alert {
      color: #e74c3c;
      font-size: .98em;
      margin-top: 6px;
      min-height: 22px;
      display: block;
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-title">
      <i class="fas fa-plug"></i> Smart Power
    </div>
    <div class="sidebar-links">
      <a class="sidebar-link" href="index.html">
        <i class="fas fa-tachometer-alt"></i> Dashboard
      </a>
      <a class="sidebar-link" href="analytics.html">
        <i class="fas fa-chart-line"></i> History / Analytics
      </a>
      <a class="sidebar-link" href="settings.html">
        <i class="fas fa-cog"></i> Settings
      </a>
      <a class="sidebar-link" href="network.html">
        <i class="fas fa-network-wired"></i> Network Info
      </a>
      <a class="sidebar-link active" href="admin.html">
        <i class="fas fa-tools"></i> System / Admin
      </a>
      <a class="sidebar-link" href="#login">
        <i class="fas fa-sign-in-alt"></i> Login
      </a>
    </div>
    <div class="sidebar-footer">
      &copy; 2025 Smart Power
    </div>
  </nav>
  <button class="sidebar-toggle" id="sidebarToggle" aria-label="Open/Close Sidebar">
    <i class="fas fa-bars"></i>
    <i class="fas fa-times"></i>
  </button>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <button class="theme-toggle-demo" id="themeToggleBtn" title="Toggle Theme">
    <i class="fas fa-moon"></i>
  </button>
  <!-- Main Content -->
  <div class="main-content" id="adminMain">
    <div class="admin-title"><i class="fas fa-tools"></i> الإدارة والصيانة</div>
    <div class="admin-card">
      <!-- أزرار النظام -->
      <div class="admin-section">
        <div class="admin-section-title"><i class="fa fa-power-off"></i> نظام الجهاز</div>
        <div class="admin-btn-row">
          <button class="admin-btn danger" onclick="confirmDialog('هل تريد إعادة تشغيل الجهاز؟','reboot')">
            <i class="fa fa-sync"></i> إعادة تشغيل
          </button>
          <button class="admin-btn danger" onclick="confirmDialog('هل تريد فعلاً مسح البيانات المخزنة؟','clearMemory')">
            <i class="fa fa-trash"></i> مسح البيانات
          </button>
          <button class="admin-btn" onclick="downloadCSV()">
            <i class="fa fa-download"></i> تحميل البيانات CSV
          </button>
        </div>
        <div class="admin-btn-row" style="margin-top:0">
          <form id="otaForm" enctype="multipart/form-data" style="display:inline-block;">
            <input style="display:inline-block;width:63%;" type="file" id="otaFile" name="firmware" accept=".bin" required>
            <button class="admin-ota-btn" type="submit"><i class="fa fa-upload"></i> رفع Firmware يدوي</button>
          </form>
        </div>
      </div>
      <!-- السجلات -->
      <div class="admin-section">
        <div class="admin-section-title"><i class="fa fa-history"></i> السجلات (Logs)</div>
        <div class="logs-list" id="logsList">
          <div class="log-item">-- لا يوجد بيانات --</div>
        </div>
      </div>
      <div class="admin-alert" id="adminAlert"></div>
    </div>
    <div class="footer">&copy; Smart Power Monitor Dashboard</div>
  </div>
  <!-- Dialog التأكيد -->
  <div class="dialog-overlay" id="dialogOverlay">
    <div class="dialog-box">
      <div class="dialog-title" id="dialogTitle"></div>
      <div class="dialog-btn-row">
        <button class="dialog-btn danger" id="dialogOkBtn">تأكيد</button>
        <button class="dialog-btn" id="dialogCancelBtn">إلغاء</button>
      </div>
    </div>
  </div>
  <!-- قفل الإدارة (مطلوب كلمة مرور) -->
  <div class="admin-lock-overlay" id="adminLockOverlay">
    <div class="admin-lock-box">
      <div class="admin-lock-title"><i class="fa fa-lock"></i> دخول الإدارة</div>
      <input class="admin-lock-input" type="password" id="adminPass" placeholder="كلمة المرور" autocomplete="current-password">
      <button class="admin-lock-btn" id="adminLoginBtn">دخول</button>
      <div class="admin-lock-alert" id="adminLockAlert"></div>
    </div>
  </div>
  <script>
    // --- Sidebar, theme toggle ---
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    sidebarToggle.onclick = () => {
      const open = !sidebar.classList.contains('open');
      sidebar.classList.toggle('open', open);
      document.body.classList.toggle('sidebar-open', open);
    };
    sidebarOverlay.onclick = () => {
      sidebar.classList.remove('open');
      document.body.classList.remove('sidebar-open');
    };
    document.querySelectorAll('.sidebar-link').forEach(link =>
      link.addEventListener('click', () => {
        sidebar.classList.remove('open');
        document.body.classList.remove('sidebar-open');
      })
    );
    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        sidebar.classList.remove('open');
        document.body.classList.remove('sidebar-open');
      }
    });
    document.getElementById('themeToggleBtn').onclick = function() {
      document.body.classList.toggle('dark');
      const icon = this.querySelector('i');
      icon.classList.toggle('fa-moon');
      icon.classList.toggle('fa-sun');
    };

    // --- قفل الإدارة ---
    function unlockAdmin(pass) {
      // استبدل التحقق المحلي بـ API حقيقي في الإنتاج
      return fetch('/api/admin/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({password: pass})
      }).then(r=>r.ok?r.json():Promise.reject())
        .then(res=>!!res.success);
    }
    const adminLockOverlay = document.getElementById('adminLockOverlay');
    const adminMain = document.getElementById('adminMain');
    document.getElementById('adminLoginBtn').onclick = function() {
      const pass = document.getElementById('adminPass').value;
      document.getElementById('adminLockAlert').textContent = '';
      if (!pass) {
        document.getElementById('adminLockAlert').textContent='يرجى إدخال كلمة المرور';
        return;
      }
      unlockAdmin(pass).then(ok=>{
        if(ok) {
          adminLockOverlay.style.display='none';
          adminMain.style.filter='none';
        } else {
          document.getElementById('adminLockAlert').textContent='كلمة المرور غير صحيحة!';
        }
      }).catch(()=> {
        document.getElementById('adminLockAlert').textContent='حدث خطأ في الاتصال!';
      });
    };
    document.getElementById('adminPass').onkeydown = function(e) {
      if (e.key === "Enter") document.getElementById('adminLoginBtn').click();
    };
    window.onload = function() {
      adminLockOverlay.style.display='flex';
      adminMain.style.filter='blur(2.5px)';
    };

    // --- Dialog التأكيد ---
    let dialogCallback = null;
    function confirmDialog(msg, action) {
      document.getElementById('dialogTitle').textContent = msg;
      document.getElementById('dialogOverlay').style.display = 'flex';
      dialogCallback = action;
    }
    document.getElementById('dialogOkBtn').onclick = function() {
      document.getElementById('dialogOverlay').style.display = 'none';
      if (dialogCallback) handleAdminAction(dialogCallback);
    };
    document.getElementById('dialogCancelBtn').onclick = function() {
      document.getElementById('dialogOverlay').style.display = 'none';
      dialogCallback = null;
    };
    document.getElementById('dialogOverlay').onclick = function(e) {
      if (e.target === this) this.style.display = 'none';
    };

    // --- أزرار النظام ---
    function setAdminAlert(msg, type="success") {
      const a = document.getElementById('adminAlert');
      a.textContent = msg;
      a.className = "admin-alert " + type;
      a.style.display = "block";
      setTimeout(()=>{a.style.display="none";}, 3000);
    }
    function handleAdminAction(action) {
      if (action === 'reboot') {
        setAdminAlert('جاري إعادة التشغيل ...', 'success');
        fetch('/api/admin/reboot', {method:'POST'})
          .then(()=>setTimeout(()=>location.reload(),2000))
          .catch(()=>setAdminAlert('فشل أمر إعادة التشغيل', 'fail'));
      }
      if (action === 'clearMemory') {
        setAdminAlert('جاري المسح ...', 'success');
        fetch('/api/admin/clear-memory', {method:'POST'})
          .then(r=>r.json()).then(r=>{
            if(r.success) setAdminAlert('تم مسح البيانات بنجاح!', 'success');
            else setAdminAlert('فشل المسح', 'fail');
          })
          .catch(()=>setAdminAlert('فشل المسح', 'fail'));
      }
    }
    function downloadCSV() {
      setAdminAlert('جاري تجهيز الملف ...', 'success');
      fetch('/api/admin/data-csv')
        .then(r=>{
          if(!r.ok) throw new Error();
          return r.blob();
        })
        .then(blob=>{
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = "data.csv";
          document.body.appendChild(a);
          a.click();
          a.remove();
          setAdminAlert('تم التحميل!', 'success');
        })
        .catch(()=>setAdminAlert('فشل تحميل الملف', 'fail'));
    }
    // --- OTA (رفع Firmware) ---
    document.getElementById('otaForm').onsubmit = function(e) {
      e.preventDefault();
      setAdminAlert('جاري رفع البرنامج ...', 'success');
      const file = document.getElementById('otaFile').files[0];
      if (!file) {
        setAdminAlert("يرجى اختيار ملف .bin", "fail");
        return;
      }
      const formData = new FormData();
      formData.append('firmware', file);
      fetch('/api/ota', {
        method: 'POST',
        body: formData
      })
      .then(r=>r.json())
      .then(data=>{
        if(data.success) {
          setAdminAlert("تم رفع وترقية البرنامج بنجاح! سيتم إعادة التشغيل.", "success");
          setTimeout(()=>location.reload(),3000);
        } else {
          setAdminAlert("فشل الترقية: " + (data.msg||""), "fail");
        }
      })
      .catch(()=>setAdminAlert("خطأ في الاتصال أو فشل الترقية!", "fail"));
    };

    // --- السجلات ---
    function fetchLogs() {
      fetch('/api/admin/logs')
        .then(r=>r.ok?r.json():Promise.reject())
        .then(data=>{
          const logsList = document.getElementById('logsList');
          logsList.innerHTML = "";
          if (!data || !data.logs || !data.logs.length) {
            logsList.innerHTML = '<div class="log-item">-- لا يوجد بيانات --</div>';
            return;
          }
          data.logs.slice(0,10).forEach(item=>{
            logsList.innerHTML += `<div class="log-item">${item}</div>`;
          });
        })
        .catch(()=>{
          document.getElementById('logsList').innerHTML = '<div class="log-item">-- خطأ في تحميل السجلات --</div>';
        });
    }
    // بعد فك القفل/دخول الإدارة
    function afterUnlock() {
      fetchLogs();
    }
    // إذا تم فك القفل، جلب السجلات
    const origUnlockAdmin = unlockAdmin;
    unlockAdmin = function(pass) {
      return origUnlockAdmin(pass).then(ok=>{
        if(ok) setTimeout(afterUnlock, 400);
        return ok;
      });
    };
  </script>
</body>
</html>